<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BduBPsYz.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.DwwtVzUN.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.C90_pPfV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DmKrRu43.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COc0ozwQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CR_4RHM7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CaC1Krpq.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BjM09ad5.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Bg7HXQff.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1-kU2YTO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cew64nlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYQQZ9Kc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dbPvbsOE.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.DmQb1gwr.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C5SEx9ip.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BFQL34oP.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.CqSAoTFj.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/3ot0CaDB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DPMIOPX_.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.CtBbnhLD.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-1l2p5et"><h1 class="svelte-1l2p5et">Electron With WebContentsView</h1> <p class="svelte-1l2p5et">2025-10-12</p></div> <section class="article-body svelte-1l2p5et"><!----><h6>用 Electron 的 WebContentsView 實作編輯器</h6> <hr/> <h3>主要架構</h3> <p>Electron 基於 <strong>Node.js</strong> 和 <strong>Chromium</strong> 建構而成：</p> <ul><li>Node.js：提供後端能力，可以存取檔案系統、作業系統 API 等原生功能</li> <li>Chromium：負責渲染使用者界面，提供現代化的網頁技術支援</li> <li>主進程 (Main Process)：負責管理應用程式生命週期、建立視窗、處理系統事件</li> <li>渲染進程 (Renderer Process)：每個視窗或 WebContentsView 都運行在獨立的渲染進程中</li></ul> <h3>WebContentsView</h3> <p>可以想像成一個獨立的瀏覽器分頁：</p> <ul><li>每個 View 運行在獨立的渲染進程中</li> <li>進程之間互相隔離，提升穩定性與安全性</li> <li>各自維護獨立的狀態，不會互相干擾</li> <li>適合用於建立多文件編輯器、分頁瀏覽器等應用</li></ul> <br/> <p>困難的地方在於模組化 WebContentsView 的配置與切換，基本設定流程會是</p> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createWCV</span><span class="token punctuation">(</span><span class="token parameter">viewType<span class="token punctuation">,</span> isIntegration <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isIsolation<span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>viewType <span class="token keyword">in</span> <span class="token constant">WEBVIEW_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> viewConfig <span class="token operator">=</span> <span class="token constant">WEBVIEW_SOURCE</span><span class="token punctuation">[</span>viewType<span class="token punctuation">]</span>
  <span class="token keyword">const</span> contentsView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebContentsView</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      webPreferences<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          nodeIntegration<span class="token operator">:</span> isIntegration<span class="token punctuation">,</span>
          contextIsolation<span class="token operator">:</span> isIsolation<span class="token punctuation">,</span>
          preload<span class="token operator">:</span> viewConfig<span class="token punctuation">.</span>preload <span class="token operator">||</span> <span class="token keyword">undefined</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  contentsView<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  contentsView<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'did-finish-load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Content WebContentsView finished loading'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  contentsView<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'dom-ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Content WebContentsView DOM ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// SOURCE_TYPES</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token constant">LOCAL_HTML</span><span class="token punctuation">,</span> <span class="token constant">REMOTE_URL</span><span class="token punctuation">,</span> <span class="token constant">SERVER_URL</span><span class="token punctuation">,</span> <span class="token constant">EMBEDDED</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token constant">SOURCE_TYPES</span>
  <span class="token keyword">const</span> srcPath <span class="token operator">=</span> viewConfig<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
  <span class="token keyword">const</span> srcType <span class="token operator">=</span> viewConfig<span class="token punctuation">.</span>srcType<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isSingleton <span class="token operator">=</span> viewConfig<span class="token punctuation">.</span>singleton <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>srcType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token constant">LOCAL_HTML</span><span class="token operator">:</span>
      <span class="token keyword">await</span> contentsView<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token constant">REMOTE_URL</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token constant">SERVER_URL</span><span class="token operator">:</span>
      <span class="token keyword">await</span> contentsView<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token constant">EMBEDDED</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FC:CreateWCView Error => Not Define SrcType'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 自訂義辨識屬性</span>
  contentsView<span class="token punctuation">.</span>_inAppCustomType <span class="token operator">=</span> viewType
  contentsView<span class="token punctuation">.</span>_isSingleton <span class="token operator">=</span> isSingleton

  <span class="token keyword">return</span> contentsView<span class="token punctuation">;</span><span class="token comment">// WebContentsView Instance</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>完成後，整體架構會類似前端框架的 Router 系統，每個 WebContentsView 定義了該頁面使用的資源來源。困難點是<strong>規格定義</strong>與<strong>實例管理</strong>，例如</p> <ul><li>編輯器視圖（多實例）：允許同時開啟多個編輯器，每個編輯不同的檔案</li> <li>預覽視圖（單實例）：整個應用只能存在一個預覽畫面，確保客戶端是看到最新渲染</li></ul> <p>也就是要解決以下問題：</p> <ul><li>實例標記：如何標記某個 View 類型是單例（Singleton）還是多例</li> <li>防呆機制：如何防止創建重複的單例 View</li> <li>實例查找：呼叫時如何確保取得正確的 View 實例</li> <li>生命週期管理：如何追蹤和清理不再使用的 View</li></ul> <p>目前我是用透過 <code>_isSingleton</code> 和 <code>_inAppCustomType</code> 來自訂屬性來標記 View，有點卡卡以後可能會再更新</p> <br/> <h3>Inter-Process Communication</h3> <p>基於安全性考量，Renderer Process 運行在沙盒環境中，無法直接存取系統資源。當需要執行特權操作（如檔案讀寫、系統 API 呼叫）時，必須透過 IPC 與 Main Process 通信。而實踐的方式類似前端的全域資料管理，都是透過<strong>統一的接口</strong>來管理和存取共享資源。</p> <br/> <p>React 為例：</p> <ul><li>整個應用共用一個 Singleton Data（例如 Context 或 Redux Store）</li> <li>需要提供 <code>update</code> API 讓元件更新資料</li> <li>某個 Renderer View 要使用時，就要 <code>import</code> 或透過事件反向 callback 注入</li></ul> <br/> <p>Electron IPC：</p> <ul><li>Main Process 管理共享資料和特權操作</li> <li>提供 IPC 通道（channel）讓 Renderer Process 請求或更新資料</li> <li>Renderer Process 透過 <code>ipcRenderer.invoke()</code> 發送請求</li> <li>Main Process 透過 <code>ipcMain.handle()</code> 處理請求並回傳結果</li></ul><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1ctgvvj = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.C90_pPfV.js"),
						import("../_app/immutable/entry/app.Bg7HXQff.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
