<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BduBPsYz.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.DwwtVzUN.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.C90_pPfV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DmKrRu43.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COc0ozwQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CR_4RHM7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CaC1Krpq.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BjM09ad5.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Bg7HXQff.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1-kU2YTO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cew64nlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYQQZ9Kc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dbPvbsOE.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.DmQb1gwr.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C5SEx9ip.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BFQL34oP.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.CqSAoTFj.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/3ot0CaDB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DPMIOPX_.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.CtBbnhLD.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-1l2p5et"><h1 class="svelte-1l2p5et">金流對帳檔案處理</h1> <p class="svelte-1l2p5et">2025-09-30</p></div> <section class="article-body svelte-1l2p5et"><!----><h6>金流商通常會在N工作日後，提供一份撥款檔案視為實際銀行帳務核實依據</h6> <hr/> <p>一般來說是每日定時觸發該任務，所以難點是當系統異常或金流商未提供檔案時，人工介入後可以怎麼處理、減少重試的成本。</p> <h3>取得金流商靜態檔案</h3> <p>從邏輯異常的話表示沒有寫入本地端，重試就從 ERROR LOG 去找參數直接重試可以了。</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 取得遠端檔案</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">DownloadRemoteFileAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> connectionJsonStr<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> storagePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> filePrefix<span class="token punctuation">,</span> <span class="token class-name">DateTime<span class="token punctuation">?</span></span> startDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DateTime<span class="token punctuation">?</span></span> endDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> yesterday <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Today<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> fromDate <span class="token operator">=</span> startDate <span class="token operator">??</span> yesterday<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> toDate <span class="token operator">=</span> endDate <span class="token operator">??</span> yesterday<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fromDate <span class="token operator">></span> toDate<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"起訖日期參數設定異常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> connectionConfig <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JsonElement<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>connectionJsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SftpConfig</span>
    <span class="token punctuation">&#123;</span>
        SftpIP <span class="token operator">=</span> connectionConfig<span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"SftpIP"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"ip is required"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SftpPort <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>connectionConfig<span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"SftpPort"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> port<span class="token punctuation">)</span><span class="token punctuation">?</span> port <span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
        SftpAccount <span class="token operator">=</span> connectionConfig<span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"SftpAccount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Account is required"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SftpPassword <span class="token operator">=</span> connectionConfig<span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"SftpPassword"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">"Password is required"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token preprocessor property">#<span class="token directive keyword">region</span> 處理遠端連線和指定檔案</span>
        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> sftpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SftpClient</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>SftpIP<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SftpPort<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SftpAccount<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SftpPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EnsureStftConnected</span><span class="token punctuation">(</span>sftpClient<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> sftpFiles <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> sftpClient<span class="token punctuation">.</span><span class="token function">ListDirectory</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> csvFiles <span class="token operator">=</span> sftpFiles<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>file <span class="token operator">=></span> file<span class="token punctuation">.</span>IsRegularFile <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span>Name<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">".csv"</span><span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> targetFiles <span class="token operator">=</span> csvFiles
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>file <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> date <span class="token operator">=</span> fromDate<span class="token punctuation">;</span> date <span class="token operator">&lt;=</span> toDate<span class="token punctuation">.</span>Date<span class="token punctuation">;</span> date <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 取得指定日期範圍資料(檔名)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>Name<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"yyyyMMdd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

        <span class="token preprocessor property">#<span class="token directive keyword">region</span> 下載至本地端</span>
        Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> filesPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> file <span class="token keyword">in</span> targetFiles<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> path <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>storagePath<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">filePrefix</span><span class="token punctuation">&#125;</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">file<span class="token punctuation">.</span>Name</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> fileStream <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> sftpClient<span class="token punctuation">.</span><span class="token function">DownloadFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> fileStream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            filesPath<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

        <span class="token keyword">return</span> filesPath<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"LinePay SFTP 下載失敗: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <h3>下載資料取得有效資料</h3> <p>很單純直接檢查該路徑檔案+重試</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">ReadFileAndGetValidLines</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> fileLines <span class="token operator">=</span> <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">ReadAllLinesAsync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    excludedLine <span class="token operator">=</span> fileLines<span class="token punctuation">.</span>Length <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">?</span> fileLines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>

    <span class="token keyword">return</span> fileLines<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根據金流商提供的規則</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <h3>解析檔案 &amp; 儲存</h3> <p>主要是解析、分類檔案，其中出現異常就Catch住保留原始資料，等待人工檢閱
重試的斷點就是把這批資料回丟這個 function 去處理</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ReconciliationResult<span class="token punctuation">></span></span> <span class="token function">ProcessReconciliation</span><span class="token punctuation">(</span><span class="token class-name">CFContext</span> db<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> storeId<span class="token punctuation">,</span> <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> successCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> unmatchedRows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> failedRows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> row <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 解析字串欄位</span>
            <span class="token class-name"><span class="token keyword">string</span></span> trx_seq <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Linepay 定義的交易號碼</span>
            <span class="token class-name"><span class="token keyword">string</span></span> pay_status <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> orderNo <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">DateTime</span> scheduled_ymd <span class="token operator">=</span> DateTime<span class="token punctuation">.</span><span class="token function">TryParseExact</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"yyyyMMdd"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> DateTimeStyles<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">DateTime</span> ymd<span class="token punctuation">)</span> <span class="token punctuation">?</span> ymd <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 撥款日</span>
            <span class="token class-name"><span class="token keyword">decimal</span></span> pay_amount <span class="token operator">=</span> <span class="token keyword">decimal</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">decimal</span></span> dmTemp<span class="token punctuation">)</span> <span class="token punctuation">?</span> dmTemp <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">decimal</span></span> fee_amount <span class="token operator">=</span> <span class="token keyword">decimal</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> dmTemp<span class="token punctuation">)</span><span class="token punctuation">?</span> dmTemp <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">decimal</span></span> tax_amount <span class="token operator">=</span> <span class="token keyword">decimal</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> dmTemp<span class="token punctuation">)</span><span class="token punctuation">?</span> dmTemp <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">decimal</span></span> total_fee_amount <span class="token operator">=</span> <span class="token keyword">decimal</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> dmTemp<span class="token punctuation">)</span><span class="token punctuation">?</span> dmTemp <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">decimal</span></span> scheduled_amount <span class="token operator">=</span> <span class="token keyword">decimal</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> dmTemp<span class="token punctuation">)</span><span class="token punctuation">?</span> dmTemp <span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>


            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 查詢現有對應資料</span>
            <span class="token comment">// ... 其餘業務邏輯</span>
            <span class="token comment">// 比對內部資料，異常就看怎麼處理</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>   
            <span class="token comment">// 系統(...DB)異常就先記錄起來</span>
            failedRows<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReconciliationResult</span>
    <span class="token punctuation">&#123;</span>
        SuccessCount <span class="token operator">=</span> successCount<span class="token punctuation">,</span>
        ProcessFailedData <span class="token operator">=</span> failedRows<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SeqNoUnmatchData <span class="token operator">=</span> unmatchedRows<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SaveRawDataToFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> savedPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> fileName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 寫入的資料(含標題)</span>
    <span class="token class-name"><span class="token keyword">var</span></span> linesToWrite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>excludedLine<span class="token punctuation">)</span><span class="token punctuation">)</span>
        linesToWrite<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>excludedLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
    linesToWrite<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 檔案名稱 &amp;&amp; 檔案路徑</span>
    Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>savedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> filePath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>savedPath<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">fileName</span><span class="token punctuation">&#125;</span></span><span class="token string">.csv"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">WriteAllLinesAsync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> linesToWrite<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <h3>提供檢閱好的靜態檔案給外部</h3> <p>在記錄對帳的表單欄位添加以下屬性，把資料庫當作SSOT
並且把 產出檔案 => 資料更新 包在同一個 Transaction
確認檔案產出再 Update 資料庫</p> <pre class="language-csharp"><!----><code class="language-csharp">CreateDate <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>
Exported <span class="token operator">=</span> <span class="token class-name">false</span>
FileName <span class="token operator">=</span> <span class="token keyword">null</span></code><!----></pre> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 產檔處理</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">GenerateStaticFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> storeID<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">List<span class="token punctuation">&lt;</span>CfReconciliation<span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _db<span class="token punctuation">.</span>CfReconciliation
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>StoreID <span class="token operator">==</span> storeID<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>exported <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 先準備 CSV 內容</span>
        <span class="token class-name"><span class="token keyword">var</span></span> linesToWrite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加入標頭（依你的需求調整）</span>
        linesToWrite<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Column1,Column2,Column3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加入資料列</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> data <span class="token keyword">in</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            linesToWrite<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">data<span class="token punctuation">.</span>StoreID</span><span class="token punctuation">&#125;</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">data<span class="token punctuation">.</span>SeqNo</span><span class="token punctuation">&#125;</span></span><span class="token string">,......"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 2. 確保目錄存在並寫入檔案</span>
        <span class="token class-name"><span class="token keyword">var</span></span> savedPath <span class="token operator">=</span> <span class="token string">"TEMP_PATH"</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> fileName <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"TEST_</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">DateTime<span class="token punctuation">.</span>Now</span><span class="token format-string"><span class="token punctuation">:</span>MMddHHmmss</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
        Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>savedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> filePath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>savedPath<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">fileName</span><span class="token punctuation">&#125;</span></span><span class="token string">.csv"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">WriteAllLinesAsync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> linesToWrite<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 檔案寫入成功後，才更新資料庫</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> data <span class="token keyword">in</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            data<span class="token punctuation">.</span>exported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>exportedTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>exportedFileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">await</span> _db<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"產檔成功: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">filePath</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"產檔失敗: StoreID=test"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1ctgvvj = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.C90_pPfV.js"),
						import("../_app/immutable/entry/app.Bg7HXQff.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
