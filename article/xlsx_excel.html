<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BlKtvRjo.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.D87DJdk2.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.DPVlgyPf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C9dELT_4.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COc0ozwQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CR_4RHM7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DimUOtpk.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BjM09ad5.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.DrNMsNyx.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1-kU2YTO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cew64nlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYQQZ9Kc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dbPvbsOE.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.CDBoRajM.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C5SEx9ip.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DBze5YnY.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.7OnaU4Sl.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/3ot0CaDB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CISL6NAv.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.1c_pFEFO.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-mdkbyj"><h1 class="svelte-mdkbyj">XLSL Excel 套件</h1> <p class="svelte-mdkbyj">2025-06-22</p></div> <section class="article-body svelte-mdkbyj"><!----><h6>紀錄一下套件用法和邏輯，<a href="https://www.npmjs.com/package/xlsx/v/0.14.1?activeTab=readme" rel="nofollow">xlsx 0.14.1</a></h6> <hr/> <h3>Workbook &amp; Worksheet</h3> <p>單個 Workbook 實例代表一份完整的xsml檔案，Worksheet 代表一頁 xsml的分頁，都可以產多個。</p> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">import</span> <span class="token constant">XLSX</span> <span class="token keyword">from</span> <span class="token string">'xlsx'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">export_xsml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Workbook 1: 包含 Sheet1</span>
  <span class="token keyword">const</span> workbook1 <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sheet1 <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">aoa_to_sheet</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'s1_1'</span><span class="token punctuation">,</span> <span class="token string">'s1_2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_append_sheet</span><span class="token punctuation">(</span>workbook1<span class="token punctuation">,</span> sheet1<span class="token punctuation">,</span> <span class="token string">'sheet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Workbook 2: 包含 Sheet1、Sheet2</span>
  <span class="token keyword">const</span> workbook2 <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sheet2 <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">aoa_to_sheet</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'s2_1'</span><span class="token punctuation">,</span> <span class="token string">'s2_2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_append_sheet</span><span class="token punctuation">(</span>workbook2<span class="token punctuation">,</span> sheet1<span class="token punctuation">,</span> <span class="token string">'sheet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_append_sheet</span><span class="token punctuation">(</span>workbook2<span class="token punctuation">,</span> sheet2<span class="token punctuation">,</span> <span class="token string">'sheet2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 匯出兩個檔案</span>
  <span class="token comment">// 一個檔案一個分頁</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>workbook1<span class="token punctuation">,</span> <span class="token string">'learning1.xlsx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 一個檔案兩個分頁</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>workbook2<span class="token punctuation">,</span> <span class="token string">'learning2.xlsx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <h3>Sheet Content</h3> <pre class="language-js"><!----><code class="language-js"><span class="token comment">// Array of Arrays, AOA</span>
<span class="token comment">// data 放入 2 維度陣列 [[row1],[row2],[row3]...]</span>
<span class="token comment">// [row1] => 'A1','B1','C1'....</span>
<span class="token comment">// options => &#123; origin: 'B2' &#125; 指定座標</span>
<span class="token keyword">const</span> ws_array <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">aoa_to_sheet</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每一個物件會轉成一列（row）</span>
<span class="token comment">// key 會自動變成表頭欄位 // row1</span>
<span class="token keyword">const</span> ws_json <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">json_to_sheet</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// row2</span>
  <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'Bob'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">&#125;</span>    <span class="token comment">// row3</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">json_to_sheet</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  header<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 明確指定欄位順序（會取代自動推斷）</span>
  skipHeader<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">// 是否要略過產生表頭（預設 false）</span>
  origin<span class="token operator">:</span> <span class="token string">'B2'</span>             <span class="token comment">// 從 B2 開始填入</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><!----></pre> <h3>Merges</h3> <p>指定哪些儲存格要上下合併</p> <pre class="language-js"><!----><code class="language-js"><span class="token comment">// s = start / e = end / A1 = &#123;x:0,y:0&#125; / A3 = &#123;x:2,y:0&#125;</span>
worksheet<span class="token punctuation">[</span><span class="token string">'!merges'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> s<span class="token operator">:</span> <span class="token punctuation">&#123;</span> r<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> e<span class="token operator">:</span> <span class="token punctuation">&#123;</span> r<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> 
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 也可以指定座標</span>
<span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">decode_range</span><span class="token punctuation">(</span><span class="token string">'A1:A3'</span><span class="token punctuation">)</span>
</code><!----></pre> <h3>多列合併實作</h3> <ul><li>假設有一筆一對多的資料列</li> <li>分割/合併儲存格的方式在EXCEL上呈現</li></ul> <p>先處理資料結構</p> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">const</span> orderList <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    OrderNo<span class="token operator">:</span> <span class="token string">'A001'</span><span class="token punctuation">,</span>
    Customer<span class="token operator">:</span> <span class="token string">'小明'</span><span class="token punctuation">,</span>
    Items<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> Product<span class="token operator">:</span> <span class="token string">'鉛筆'</span><span class="token punctuation">,</span> Quantity<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> Product<span class="token operator">:</span> <span class="token string">'原子筆'</span><span class="token punctuation">,</span> Quantity<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    OrderNo<span class="token operator">:</span> <span class="token string">'A002'</span><span class="token punctuation">,</span>
    Customer<span class="token operator">:</span> <span class="token string">'小美'</span><span class="token punctuation">,</span>
    Items<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> Product<span class="token operator">:</span> <span class="token string">'橡皮擦'</span><span class="token punctuation">,</span> Quantity<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> flattenedList <span class="token operator">=</span> orderList<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">order</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> items <span class="token operator">=</span> order<span class="token punctuation">.</span>Items<span class="token punctuation">.</span>length <span class="token operator">?</span> order<span class="token punctuation">.</span>Items <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>order<span class="token punctuation">,</span>
    <span class="token operator">...</span>item<span class="token punctuation">,</span>
    _rowCount<span class="token operator">:</span> items<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token comment">// 紀錄有幾筆資料</span>
    _isFirst<span class="token operator">:</span> index <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">// 添加新屬性標記</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 資料攤平後會</span>
<span class="token keyword">const</span> flattenedList <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    OrderNo<span class="token operator">:</span> <span class="token string">'A001'</span><span class="token punctuation">,</span>
    Customer<span class="token operator">:</span> <span class="token string">'小明'</span><span class="token punctuation">,</span>
    Product<span class="token operator">:</span> <span class="token string">'鉛筆'</span><span class="token punctuation">,</span>
    Quantity<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    _rowCount<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    _isFirst<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    OrderNo<span class="token operator">:</span> <span class="token string">'A001'</span><span class="token punctuation">,</span>
    Customer<span class="token operator">:</span> <span class="token string">'小明'</span><span class="token punctuation">,</span>
    Product<span class="token operator">:</span> <span class="token string">'原子筆'</span><span class="token punctuation">,</span>
    Quantity<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    _rowCount<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    _isFirst<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    OrderNo<span class="token operator">:</span> <span class="token string">'A002'</span><span class="token punctuation">,</span>
    Customer<span class="token operator">:</span> <span class="token string">'小美'</span><span class="token punctuation">,</span>
    Product<span class="token operator">:</span> <span class="token string">'橡皮擦'</span><span class="token punctuation">,</span>
    Quantity<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    _rowCount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    _isFirst<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code><!----></pre> <p>處理合併欄位</p> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">const</span> exportKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'OrderNo'</span><span class="token punctuation">,</span> <span class="token string">'Customer'</span><span class="token punctuation">,</span> <span class="token string">'Product'</span><span class="token punctuation">,</span> <span class="token string">'Quantity'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Table Header</span>
<span class="token keyword">const</span> mergeKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'OrderNo'</span><span class="token punctuation">,</span> <span class="token string">'Customer'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 指定的合併欄位</span>
<span class="token keyword">const</span> dataOffset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 指定 Y 軸起始座標</span>
<span class="token keyword">const</span> merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放資料</span>

flattenedList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> rowIndex</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 用剛剛的 _isFirst 判斷是否為第一筆</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>row<span class="token punctuation">.</span>_isFirst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 總共合併的列數</span>
    <span class="token keyword">const</span> rowspan <span class="token operator">=</span> row<span class="token punctuation">.</span>_rowCount<span class="token punctuation">;</span> 
    mergeKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 鎖定該X軸</span>
      <span class="token keyword">const</span> colIndex <span class="token operator">=</span> exportKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>colIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> rowspan <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 關鍵是利用 ForEach 中的 rowIndex 保持 Y 軸該擺放的位置</span>
        <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">encode_cell</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> r<span class="token operator">:</span> rowIndex <span class="token operator">+</span> dataOffset<span class="token punctuation">,</span> c<span class="token operator">:</span> colIndex <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">encode_cell</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> r<span class="token operator">:</span> rowIndex <span class="token operator">+</span> dataOffset <span class="token operator">+</span> rowspan <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token operator">:</span> colIndex <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        merges<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>start<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>end<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><!----></pre> <p>完整流程</p> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">XLSX</span> <span class="token keyword">from</span> <span class="token string">'xlsx'</span><span class="token punctuation">;</span>

<span class="token comment">// === 1. 建立 worksheet from JSON，指定欄位與起始位置 ===</span>
<span class="token keyword">const</span> worksheet <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">json_to_sheet</span><span class="token punctuation">(</span>flattenedList<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  header<span class="token operator">:</span> exportKeys<span class="token punctuation">,</span>
  skipHeader<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  origin<span class="token operator">:</span> <span class="token string">'A2'</span> <span class="token comment">// 表示資料從 A2 開始填（A1 為表頭）</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// === 2. 加入欄位表頭於 A1 ===</span>
exportKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cellRef <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">encode_cell</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> r<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token operator">:</span> i <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// A1, B1, ...</span>
  worksheet<span class="token punctuation">[</span>cellRef<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> t<span class="token operator">:</span> <span class="token string">'s'</span><span class="token punctuation">,</span> v<span class="token operator">:</span> key <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 你可改成中文名</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// === 3. 計算合併欄位範圍 ===</span>
<span class="token keyword">const</span> merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
flattenedList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> rowIndex</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>row<span class="token punctuation">.</span>_isFirst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> rowspan <span class="token operator">=</span> row<span class="token punctuation">.</span>_rowCount<span class="token punctuation">;</span>
    mergeKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> colIndex <span class="token operator">=</span> exportKeys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>colIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> rowspan <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> r1 <span class="token operator">=</span> rowIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 因為 origin: 'A2'，rowIndex 0 是第2列</span>
        <span class="token keyword">const</span> r2 <span class="token operator">=</span> r1 <span class="token operator">+</span> rowspan <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        merges<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> s<span class="token operator">:</span> <span class="token punctuation">&#123;</span> r<span class="token operator">:</span> r1<span class="token punctuation">,</span> c<span class="token operator">:</span> colIndex <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> e<span class="token operator">:</span> <span class="token punctuation">&#123;</span> r<span class="token operator">:</span> r2<span class="token punctuation">,</span> c<span class="token operator">:</span> colIndex <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worksheet<span class="token punctuation">[</span><span class="token string">'!merges'</span><span class="token punctuation">]</span> <span class="token operator">=</span> merges<span class="token punctuation">;</span>

<span class="token comment">// 可選：欄寬</span>
worksheet<span class="token punctuation">[</span><span class="token string">'!cols'</span><span class="token punctuation">]</span> <span class="token operator">=</span> exportKeys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> wch<span class="token operator">:</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// === 4. 建立 workbook 並加入 worksheet ===</span>
<span class="token keyword">const</span> workbook <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_append_sheet</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> worksheet<span class="token punctuation">,</span> <span class="token string">'Sheet1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// === 5. 匯出 ===</span>
<span class="token keyword">const</span> wbout <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  bookType<span class="token operator">:</span> <span class="token string">'xlsx'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'binary'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">s2ab</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> view<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">saveAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">s2ab</span><span class="token punctuation">(</span>wbout<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'application/octet-stream'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">report_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.xlsx</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_aq9pyy = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.DPVlgyPf.js"),
						import("../_app/immutable/entry/app.DrNMsNyx.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
