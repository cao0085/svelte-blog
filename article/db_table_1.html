<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BKcuGzEh.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.DwwtVzUN.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.CLfLHuFD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BGg-HerL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COc0ozwQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CR_4RHM7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DEx4WUL6.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BjM09ad5.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.DqJbFRPL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1-kU2YTO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cew64nlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYQQZ9Kc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dbPvbsOE.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BLGHA7Kr.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C5SEx9ip.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D3uDGXPO.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.oRkaCb4k.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/3ot0CaDB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BOlNsIVV.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.DuUjueeu.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-1l2p5et"><h1 class="svelte-1l2p5et">資料庫表單設計</h1> <p class="svelte-1l2p5et">2025-06-22</p></div> <section class="article-body svelte-1l2p5et"><!----><h3>Recursive Hierarchy</h3> <p>需要儲存的資料性質為能夠</p> <ul><li>ID</li> <li>辨識父節點的 ID</li> <li>其他業務欄位一樣（如名稱、排序、狀態…）</li></ul> <h3>鄰接表 Adjacency List</h3> <p>表單內欄位直接標示 <code>UpCode</code></p> <table><thead><tr><th>ID</th><th>UpCode</th><th>Name</th></tr></thead><tbody><tr><td>1</td><td>NULL</td><td>電子產品</td></tr><tr><td>2</td><td>1</td><td>手機</td></tr><tr><td>3</td><td>1</td><td>筆記型電腦</td></tr><tr><td>4</td><td>2</td><td>智慧型手機</td></tr></tbody></table> <pre class="language-sql"><!----><code class="language-sql">
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Category <span class="token punctuation">(</span>
  ID            <span class="token keyword">BIGINT</span>       <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  UpCode        <span class="token keyword">BIGINT</span>       <span class="token boolean">NULL</span>      <span class="token comment">-- 指向父節點 ID（根節點 UpCode = NULL）</span>
  Name          NVARCHAR<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  SortOrder     <span class="token keyword">INT</span>           <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  State         <span class="token keyword">TINYINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 多層查詢（SQL Server 迴圈 CTE）</span>
<span class="token comment">-- 先查 最上層 &amp; 添加臨時欄位 Level = 1</span>
<span class="token keyword">WITH</span> RecursiveCTE <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span> ID<span class="token punctuation">,</span> UpCode<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">AS</span> <span class="token keyword">Level</span>
  <span class="token keyword">FROM</span> Category
  <span class="token keyword">WHERE</span> UpCode <span class="token operator">IS</span> <span class="token boolean">NULL</span>

  <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>

  <span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>UpCode<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token keyword">Level</span> <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token keyword">FROM</span> Category c
  <span class="token keyword">JOIN</span> RecursiveCTE r
    <span class="token keyword">ON</span> c<span class="token punctuation">.</span>UpCode <span class="token operator">=</span> r<span class="token punctuation">.</span>ID
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> RecursiveCTE
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">Level</span><span class="token punctuation">,</span> ID<span class="token punctuation">;</span>
</code><!----></pre> <h3>Nested Set</h3> <p>用樹狀的概念來分類表，查找快速但新增和修改不容易維護</p> <pre class="language-scss"><!----><code class="language-scss">1. 類別A <span class="token punctuation">(</span>ID=1<span class="token punctuation">)</span>
   ├─ 子類A1 <span class="token punctuation">(</span>ID=3<span class="token punctuation">)</span>
   └─ 子類A2 <span class="token punctuation">(</span>ID=4<span class="token punctuation">)</span>

2. 類別B <span class="token punctuation">(</span>ID=2<span class="token punctuation">)</span>
   └─ 子類B1 <span class="token punctuation">(</span>ID=5<span class="token punctuation">)</span></code><!----></pre> <table><thead><tr><th>ID</th><th>Name</th><th>Lft</th><th>Rgt</th></tr></thead><tbody><tr><td>1</td><td>類別A</td><td>1</td><td>6</td></tr><tr><td>3</td><td>子類A1</td><td>2</td><td>3</td></tr><tr><td>4</td><td>子類A2</td><td>4</td><td>5</td></tr><tr><td>2</td><td>類別B</td><td>7</td><td>10</td></tr><tr><td>5</td><td>子類B1</td><td>8</td><td>9</td></tr></tbody></table> <pre class="language-sql"><!----><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> CategoryNested <span class="token punctuation">(</span>
  ID      <span class="token keyword">BIGINT</span>       <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  Name    NVARCHAR<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  Lft     <span class="token keyword">INT</span>           <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- 左值</span>
  Rgt     <span class="token keyword">INT</span>           <span class="token operator">NOT</span> <span class="token boolean">NULL</span>   <span class="token comment">-- 右值</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 假設要撈出「類別A」(ID=1) 的所有子孫（含自己）：</span>
<span class="token keyword">SELECT</span> node<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> CategoryNested <span class="token keyword">AS</span> node
<span class="token keyword">JOIN</span> CategoryNested <span class="token keyword">AS</span> parent
  <span class="token keyword">ON</span> node<span class="token punctuation">.</span>Lft <span class="token operator">BETWEEN</span> parent<span class="token punctuation">.</span>Lft <span class="token operator">AND</span> parent<span class="token punctuation">.</span>Rgt
<span class="token keyword">WHERE</span> parent<span class="token punctuation">.</span>ID <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> node<span class="token punctuation">.</span>Lft<span class="token punctuation">;</span>

<span class="token comment">-- 新增主類別的話需要重新計算樹</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@newId</span> <span class="token keyword">INT</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@newName</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">=</span> N<span class="token string">'類別C'</span><span class="token punctuation">;</span>

<span class="token comment">-- 1. 找到目前最大的右值</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@maxRgt</span> <span class="token keyword">INT</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>Rgt<span class="token punctuation">)</span> <span class="token keyword">FROM</span> CategoryNested<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 先把所有 Lft >= maxRgt+1 的值往後推 2</span>
<span class="token keyword">UPDATE</span> CategoryNested
<span class="token keyword">SET</span> Lft <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> Lft <span class="token operator">></span> <span class="token variable">@maxRgt</span> <span class="token keyword">THEN</span> Lft <span class="token operator">+</span> <span class="token number">2</span> <span class="token keyword">ELSE</span> Lft <span class="token keyword">END</span><span class="token punctuation">,</span>
    Rgt <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> Rgt <span class="token operator">>=</span> <span class="token variable">@maxRgt</span> <span class="token keyword">THEN</span> Rgt <span class="token operator">+</span> <span class="token number">2</span> <span class="token keyword">ELSE</span> Rgt <span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 插入新節點，左右值分別為 maxRgt+1, maxRgt+2</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> CategoryNested <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> Lft<span class="token punctuation">,</span> Rgt<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token variable">@newId</span><span class="token punctuation">,</span> <span class="token variable">@newName</span><span class="token punctuation">,</span> <span class="token variable">@maxRgt</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@maxRgt</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <h3>Materialized Path（路徑枚舉）</h3> <p>使用似 URL 的方式管理</p> <table><thead><tr><th>ID</th><th>Path</th><th>Name</th></tr></thead><tbody><tr><td>1</td><td><code>/1/</code></td><td>電子產品</td></tr><tr><td>2</td><td><code>/1/2/</code></td><td>手機</td></tr><tr><td>4</td><td><code>/1/2/4/</code></td><td>智慧型手機</td></tr><tr><td>3</td><td><code>/1/3/</code></td><td>筆記型電腦</td></tr></tbody></table> <pre class="language-sql"><!----><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> CategoryPath <span class="token punctuation">(</span>
  ID      <span class="token keyword">BIGINT</span>        <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  Path    NVARCHAR<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- 以 "/" 分隔的父節點路徑</span>
  Name    NVARCHAR<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <h3>Closure Table（關係表）</h3> <pre class="language-sql"><!----><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Category <span class="token punctuation">(</span>
  ID   <span class="token keyword">BIGINT</span>        <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  Name NVARCHAR<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> CategoryClosure <span class="token punctuation">(</span>
  Ancestor   <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- 祖先節點</span>
  Descendant <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- 後代節點</span>
  Depth      <span class="token keyword">INT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token comment">-- 兩者間距離：0 = 自己</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>Ancestor<span class="token punctuation">,</span> Descendant<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><!----></pre> <pre class="language-scss"><!----><code class="language-scss">A <span class="token punctuation">(</span>ID=1<span class="token punctuation">)</span>
├─ B <span class="token punctuation">(</span>ID=2<span class="token punctuation">)</span>
│   └─ D <span class="token punctuation">(</span>ID=4<span class="token punctuation">)</span>
└─ C <span class="token punctuation">(</span>ID=3<span class="token punctuation">)</span></code><!----></pre> <ul><li><p>Category table</p> <table><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody><tr><td>1</td><td>A</td></tr><tr><td>2</td><td>B</td></tr><tr><td>3</td><td>C</td></tr><tr><td>4</td><td>D</td></tr></tbody></table></li> <li><p>CategoryClosure</p> <table><thead><tr><th>Ancestor</th><th>Descendant</th><th>Depth</th><th></th></tr></thead><tbody><tr><td>1</td><td>1</td><td>0</td><td>← A→A</td></tr><tr><td>2</td><td>2</td><td>0</td><td>← B→B</td></tr><tr><td>3</td><td>3</td><td>0</td><td>← C→C</td></tr><tr><td>4</td><td>4</td><td>0</td><td>← D→D</td></tr><tr><td>1</td><td>2</td><td>1</td><td>← A→B</td></tr><tr><td>1</td><td>3</td><td>1</td><td>← A→C</td></tr><tr><td>2</td><td>4</td><td>1</td><td>← B→D</td></tr><tr><td>1</td><td>4</td><td>2</td><td>← A→D</td></tr></tbody></table></li></ul> <p>查詢</p> <pre class="language-sql"><!----><code class="language-sql"><span class="token comment">-- 查詢某節點的所有後代（含自己）</span>
<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Category <span class="token keyword">AS</span> c
<span class="token keyword">JOIN</span> CategoryClosure <span class="token keyword">AS</span> cc
  <span class="token keyword">ON</span> c<span class="token punctuation">.</span>ID <span class="token operator">=</span> cc<span class="token punctuation">.</span>Descendant
<span class="token keyword">WHERE</span> cc<span class="token punctuation">.</span>Ancestor <span class="token operator">=</span> <span class="token variable">@nodeId</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> cc<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span>

<span class="token comment">-- 查詢某節點的所有祖先（含自己）   </span>
<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Category <span class="token keyword">AS</span> c
<span class="token keyword">JOIN</span> CategoryClosure <span class="token keyword">AS</span> cc
  <span class="token keyword">ON</span> c<span class="token punctuation">.</span>ID <span class="token operator">=</span> cc<span class="token punctuation">.</span>Ancestor
<span class="token keyword">WHERE</span> cc<span class="token punctuation">.</span>Descendant <span class="token operator">=</span> <span class="token variable">@nodeId</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> cc<span class="token punctuation">.</span>Depth<span class="token punctuation">;</span></code><!----></pre> <p>插入</p> <ul><li>主表先 INSERT 一筆新節點，取得它的 ID = @newId</li></ul> <pre class="language-sql"><!----><code class="language-sql"><span class="token comment">-- 對所有 ancestor of parentId，插入新後代關係</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> CategoryClosure <span class="token punctuation">(</span>Ancestor<span class="token punctuation">,</span> Descendant<span class="token punctuation">,</span> Depth<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> Ancestor<span class="token punctuation">,</span> <span class="token variable">@newId</span><span class="token punctuation">,</span> Depth <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">FROM</span> CategoryClosure
<span class="token keyword">WHERE</span> Descendant <span class="token operator">=</span> <span class="token variable">@parentId</span><span class="token punctuation">;</span>

<span class="token comment">-- 再插一筆自己到自己的對應</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> CategoryClosure <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token variable">@newId</span><span class="token punctuation">,</span> <span class="token variable">@newId</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p>刪除</p> <ul><li>先刪除 Closure Table 中任何以該節點為 Ancestor 或 Descendant 的紀錄，然後刪除主表中的那筆節點</li></ul><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_18f1rhy = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.CLfLHuFD.js"),
						import("../_app/immutable/entry/app.DqJbFRPL.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
