<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BduBPsYz.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.DwwtVzUN.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.EwUjS_sf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cwisamc5.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COc0ozwQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CR_4RHM7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CZACWngs.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BjM09ad5.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Bz0Amwnm.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1-kU2YTO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cew64nlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYQQZ9Kc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dbPvbsOE.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.WvBEohMD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C5SEx9ip.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CD718onY.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.8Obbqntv.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/3ot0CaDB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BHuhVocu.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.BdPDI5gZ.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-1l2p5et"><h1 class="svelte-1l2p5et">Finite-State Machine</h1> <p class="svelte-1l2p5et">2025-06-22</p></div> <section class="article-body svelte-1l2p5et"><!----><h6>導入類比電路的概念來實作，用金流串接當作範例</h6> <hr/> <h3>核心概念</h3> <p>狀態是封閉集合：Pending / Paid / Failed / RefundPending / Refunded。事件（Trigger）是唯一入口：只有明確的事件才能讓狀態改變。</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">// 狀態（State）</span>
<span class="token function">Pending</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> → <span class="token function">Paid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> → <span class="token function">RefundPending</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> → <span class="token function">Refunded</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">Failed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">// 失敗 / 終端狀態</span>

<span class="token comment">// 事件（Trigger）</span>
PaySucceeded<span class="token punctuation">,</span> PayFailed<span class="token punctuation">,</span> StartRefund<span class="token punctuation">,</span> RefundSucceeded<span class="token punctuation">,</span> RefundFailed</code><!----></pre> <table><thead><tr><th>CurrentState</th><th>Trigger</th><th>NextState</th></tr></thead><tbody><tr><td>Pending</td><td>PaySucceeded</td><td>Paid</td></tr><tr><td>Pending</td><td>PayFailed</td><td>Failed</td></tr><tr><td>Paid</td><td>StartRefund</td><td>RefundPending</td></tr><tr><td>RefundPending</td><td>RefundSucceeded</td><td>Refunded</td></tr><tr><td>RefundPending</td><td>RefundFailed</td><td>Paid</td></tr><tr><td>Failed/Refunded</td><td><em>(無任何事件)</em></td><td><em>(終點)</em></td></tr></tbody></table> <h3>簡易流程</h3> <pre class="language-csharp"><!----><code class="language-csharp">
<span class="token comment">// 建立 FSM</span>
<span class="token class-name"><span class="token keyword">var</span></span> fsm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PaymentStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PaymentState<span class="token punctuation">)</span>order<span class="token punctuation">.</span>State<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 解析金流商回傳碼</span>
<span class="token class-name">PaymentTrigger<span class="token punctuation">?</span></span> t <span class="token operator">=</span> dto<span class="token punctuation">.</span>ReturnCode <span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"0000"</span> <span class="token operator">=></span> PaySucceeded<span class="token punctuation">,</span>
    <span class="token string">"1165"</span> <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">,</span>         <span class="token comment">// 不轉移，維持 Pending</span>
     _     <span class="token operator">=></span> PayFailed
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span> fsm<span class="token punctuation">.</span><span class="token function">Fire</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 交易寫 DB 前</span>
order<span class="token punctuation">.</span>State            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>fsm<span class="token punctuation">.</span>CurrentState<span class="token punctuation">;</span>
vendorPayment<span class="token punctuation">.</span>PayState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>fsm<span class="token punctuation">.</span>CurrentState<span class="token punctuation">;</span>

<span class="token comment">// 回應前端也看 fsm.CurrentState</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>fsm<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> PaymentState<span class="token punctuation">.</span>Paid<span class="token punctuation">:</span>     <span class="token comment">// 成功</span>
    <span class="token keyword">case</span> PaymentState<span class="token punctuation">.</span>Pending<span class="token punctuation">:</span>  <span class="token comment">// 等待</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>                    <span class="token comment">// 失敗</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>限制行為的方式</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fsm<span class="token punctuation">.</span><span class="token function">CanFire</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token string">"非法動作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsm<span class="token punctuation">.</span><span class="token function">Fire</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <h3>測試與擴充</h3> <p>單元測試每條轉移：「Pending → PaySucceeded → Paid」。</p> <p>新增流程：只要在 enum + 轉移表多加一條，和對應 trigger 的處理；主程式 switch(fsm.CurrentState) 自動接手 DB 差異。</p><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_mt374p = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.EwUjS_sf.js"),
						import("../_app/immutable/entry/app.Bz0Amwnm.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
