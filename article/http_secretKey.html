<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BlKtvRjo.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.D87DJdk2.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.DDqIF5JP.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/ByVliOMU.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/n9CujY7_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BP3rl4Hc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BGLOmdlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Z6cp3h9-.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.CjO81wrs.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/oXeaZXhI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/YtJmKh14.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/xsVDlqqI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CgBhAJqo.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B7Qc7Rs7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CqQaArfp.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BOY0Dopy.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/0GNeBg98.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CGIRYF0y.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.xNvaVjdb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dgv3LvGf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BLR-JKVV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bx34spGl.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.CWf88C1l.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs"></div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-mdkbyj"><h1 class="svelte-mdkbyj">Http 加密</h1> <p class="svelte-mdkbyj">2025-09-23</p></div> <section class="article-body svelte-mdkbyj"><!----><hr/> <h3>SHA256 - 雙方同步加密</h3> <p>雙方約定使用同一組字串、演算法生成【HASH】當作簽名，一樣就當作比對成功</p> <p>實作:</p> <ol><li>雙方私下約定一組 KEY 都用 HMAC-SHA256 加密</li> <li>發送方在 Header 加入生成的【簽名】、【時間戳】，可以把【時間戳】當成是方便使用和驗證的變數</li> <li>接收方先拿明文的【時間戳】檢查是否在有效期間，接者用 KEY+TIME 生成簽名</li> <li>若產出值一樣就代表成功</li></ol> <pre class="language-js"><!----><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">secretKey</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">HMAC</span><span class="token operator">-</span><span class="token constant">SHA256</span><span class="token punctuation">(</span>TimeStemp <span class="token operator">+</span> Key<span class="token punctuation">)</span> <span class="token comment">// 產生密鑰</span>
header <span class="token operator">:</span> secretKey
header <span class="token operator">:</span> TimeStemp
<span class="token comment">// https request -> Service Server</span></code><!----></pre> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">// Service Server</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidateSignature</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> timestamp<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> receivedSignature<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> secretKey <span class="token operator">=</span> _configuration<span class="token punctuation">[</span><span class="token string">"ApiSecurity:SecretKey"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 發給對方的KEY</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"未設定 SecretKey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> dataToSign <span class="token operator">=</span> timestamp <span class="token operator">+</span> secretKey<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> expectedSignature <span class="token operator">=</span> <span class="token function">ComputeHmacSha256</span><span class="token punctuation">(</span>dataToSign<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用同一個加密演算法生成簽名</span>

    <span class="token comment">// 比對有無一樣、不做解密</span>
    <span class="token keyword">return</span> expectedSignature<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>receivedSignature<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 計算 HMAC-SHA256 簽名</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ComputeHmacSha256</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> hmac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> hashBytes <span class="token operator">=</span> hmac<span class="token punctuation">.</span><span class="token function">ComputeHash</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToHexString</span><span class="token punctuation">(</span>hashBytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
</code><!----></pre> <h3>RSA - 約定加密</h3> <p>金鑰值是由RSA演算法生成一對【Private / Public】Key，雙方用KEY加解密和辨識。</p> <p>實作:</p> <ol><li>接收方私下提供一組 PublicKey 給發送方，自己維護一組 PrivateKey</li> <li>發送方用 PublicKey + RSA 去加密字串如 “ServerName|TimeStamp” 後把值放到 Header</li> <li>接收方拿到 Header 值後使用 PrivateKey + RSA 去解密取得 “ServerName|TimeStamp”</li> <li>接收方可以自己去驗證 ServerName 是否在名單 &amp; TimeStamp 等邏輯</li></ol> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActionExecuting</span><span class="token punctuation">(</span><span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 取得 Header 中的加密數據</span>
        <span class="token comment">// 測試網址 https://www.devglan.com/online-tools/rsa-encryption-decryption</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"X-Encrypted-Data"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> encryptedHeader<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"缺少必要的 Header: X-Encrypted-Data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnauthorizedObjectResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">&#123;</span> message <span class="token operator">=</span> <span class="token string">"缺少必要的驗證 Header"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> encryptedData <span class="token operator">=</span> encryptedHeader<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 解密並驗證</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DecryptAndValidate</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"解密驗證失敗"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnauthorizedObjectResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">&#123;</span> message <span class="token operator">=</span> <span class="token string">"解密驗證失敗"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"RSA 簽名驗證過程發生錯誤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StatusCodeResult</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnActionExecuting</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 驗證時間戳是否在有效範圍內 (3分鐘)</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidateTimestamp</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> timestamp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> requestTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> currentTime <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> timeoutMinutes <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 固定3分鐘</span>
    <span class="token class-name"><span class="token keyword">var</span></span> maxDifference <span class="token operator">=</span> timeoutMinutes <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span> <span class="token comment">// 轉換為秒</span>

    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span>currentTime <span class="token operator">-</span> requestTime<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> maxDifference<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 解密並驗證數據</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">DecryptAndValidate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedData<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> privateKeyPath <span class="token operator">=</span> _configuration<span class="token punctuation">[</span><span class="token string">"ApiSecurity:RSAPrivateKeyPath"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> privateKeyPem <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>privateKeyPath<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> validServer <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"ApiSecurity:RSAValidServer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Get</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>privateKeyPem<span class="token punctuation">)</span> <span class="token operator">||</span> validServer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> validServer<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"未設定 RSA 私鑰、有效的公鑰列表"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 解密數據</span>
        <span class="token class-name"><span class="token keyword">var</span></span> decryptedText <span class="token operator">=</span> <span class="token function">DecryptRSA</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> privateKeyPem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>decryptedText<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"RSA 解密失敗"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 解析解密後的數據 (格式: ServerStr|timestamp)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParseDecryptedData</span><span class="token punctuation">(</span>decryptedText<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"解密數據格式錯誤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 驗證時間戳</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ValidateTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"時間戳驗證失敗: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">timestamp</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 驗證公鑰是否為我方發行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ValidatePublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> validServer<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"公鑰驗證失敗，非我方發行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"RSA 解密驗證過程發生錯誤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// RSA 解密</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">DecryptRSA</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> encryptedData<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> privateKeyPem<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> encryptedBytes <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> rsa <span class="token operator">=</span> RSA<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rsa<span class="token punctuation">.</span><span class="token function">ImportFromPem</span><span class="token punctuation">(</span>privateKeyPem<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> decryptedBytes <span class="token operator">=</span> rsa<span class="token punctuation">.</span><span class="token function">Decrypt</span><span class="token punctuation">(</span>encryptedBytes<span class="token punctuation">,</span> RSAEncryptionPadding<span class="token punctuation">.</span>Pkcs1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>decryptedBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"RSA 解密失敗"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 解析解密後的數據</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ParseDecryptedData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> decryptedText<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">string</span></span> timestamp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    publicKey <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    timestamp <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 格式為: ServerStr|timestamp</span>
        <span class="token class-name"><span class="token keyword">var</span></span> parts <span class="token operator">=</span> decryptedText<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        publicKey <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        timestamp <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// &lt;summary></span>
<span class="token comment">/// 驗證公鑰是否為我方發行</span>
<span class="token comment">/// &lt;/summary></span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidatePublicKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> publicKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> validPublicKeys<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> validPublicKeys<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_slbq0u = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.DDqIF5JP.js"),
						import("../_app/immutable/entry/app.CjO81wrs.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
