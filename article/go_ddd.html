<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BlKtvRjo.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.D87DJdk2.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.Ydrp4lmE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BXJXbgDY.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/n9CujY7_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BP3rl4Hc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CNCWaNky.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Z6cp3h9-.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.BSv_Adcq.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/oXeaZXhI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/YtJmKh14.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/xsVDlqqI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CgBhAJqo.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B7Qc7Rs7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CqQaArfp.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.Bez9QqLD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/0GNeBg98.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bjry1Qtg.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.CrHtDSL_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dgv3LvGf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BLR-JKVV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/ui6y7Ki0.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.vD6Cr1Lc.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs"></div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-mdkbyj"><h1 class="svelte-mdkbyj">DDD Architecture</h1> <p class="svelte-mdkbyj">2026-02-04</p></div> <section class="article-body svelte-mdkbyj"><!----><h6>DDD 複雜的是定義規則，模型出來後就是想辦法呵護直到寫入資料庫</h6> <hr/> <p>DDD 全名是 Domain Driven Design，實作前先分享我對這個概念的理解和是怎麼延伸出領域物件。</p> <h3>Error Data</h3> <p>當系統儲存了錯誤的資料，事後修正的成本遠高於在寫入前就擋下來。也就是如果能保證從使用者輸入到儲存的過程中完全不會出錯，那直接把資料丟進 Excel 就夠了，也不用透過系統去處理了。</p> <p>實際情況當然是不可能，所以會透過各種手段降低錯誤資料儲存的機率：</p> <ul><li><code>UI Input Rule</code>: 讓使用者在輸入時就即時發現錯誤</li> <li><code>Strongly Typed Language</code>: 在編譯期防止開發人員犯錯</li> <li><code>DB Column Type</code>: 在儲存層防止不合法的資料寫入</li></ul> <p>但這些只能防止部份的錯誤（型別錯、欄位空值等），無法防止「業務上的錯誤」。</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">type</span> Stock <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    quantity <span class="token builtin">int32</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// A. 預購系統</span>
db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>Stock<span class="token punctuation">.</span>quantity <span class="token operator">-</span> order<span class="token punctuation">)</span>

<span class="token comment">// B. 零售系統</span>
<span class="token keyword">if</span> Stock<span class="token punctuation">.</span>quantity <span class="token operator">-</span> order <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token comment">// 超賣</span>
<span class="token punctuation">&#125;</span>
db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>Stock<span class="token punctuation">.</span>quantity <span class="token operator">-</span> order<span class="token punctuation">)</span></code><!----></pre> <p>這就是 DDD 要解決的問題，把業務規則定義在模型上，任何地方要修改資料都必須經過模型驗證，不合法就拋錯，從源頭保證資料的一致性。</p> <pre class="language-go"><!----><code class="language-go"><span class="token comment">// 預購系統 Domain Model</span>
<span class="token keyword">type</span> PreOrderStock <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    quantity <span class="token builtin">int32</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>PreOrderStock<span class="token punctuation">)</span> <span class="token function">Deduct</span><span class="token punctuation">(</span>order <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    s<span class="token punctuation">.</span>quantity <span class="token operator">-=</span> order <span class="token comment">// 允許負數，代表預購量</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <pre class="language-go"><!----><code class="language-go"><span class="token comment">// 零售系統 Domain Model</span>
<span class="token keyword">type</span> RetailStock <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    quantity <span class="token builtin">int32</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>RetailStock<span class="token punctuation">)</span> <span class="token function">Deduct</span><span class="token punctuation">(</span>order <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>quantity <span class="token operator">-</span> order <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"insufficient stock"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    s<span class="token punctuation">.</span>quantity <span class="token operator">-=</span> order
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <h3>Core</h3> <p>DDD 的核心概念由 Aggregate 和 Value Object 組成，用手機來舉例:</p> <ul><li><p>Aggregate: 每一台手機拆開都會有一組 Serial Num 具有唯一識別性（ID）。即使兩台手機型號、顏色完全相同，Serial Num 不同就是不同的手機。</p></li> <li><p>Value Object: 手機的螢幕尺寸、顏色、電池容量這些屬性沒有自己的 ID，純粹由值來定義。</p></li></ul> <p>但實務上 Value Object 和普通欄位的界線會有點模糊，例如「顏色」最終就是用 string 欄位儲存？或是需要特別抽象成 <code>type Color</code> 用列舉驗證？</p> <p>總結來說 Aggregate 就是由複數個定義好的欄位與 Value Object 組成，並透過業務規則盡可能保護這些值的正確性。</p><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_upoc1o = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.Ydrp4lmE.js"),
						import("../_app/immutable/entry/app.BSv_Adcq.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
