<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.BlKtvRjo.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CzhWGdCx.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.D87DJdk2.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.DDqIF5JP.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/ByVliOMU.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/n9CujY7_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BP3rl4Hc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BGLOmdlL.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Z6cp3h9-.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.CjO81wrs.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/oXeaZXhI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/YtJmKh14.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/xsVDlqqI.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CgBhAJqo.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B7Qc7Rs7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CqQaArfp.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BOY0Dopy.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/0GNeBg98.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CGIRYF0y.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.xNvaVjdb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dgv3LvGf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BLR-JKVV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bx34spGl.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.CWf88C1l.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs"></div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="article-layout svelte-10kcmdg"><aside class="svelte-10kcmdg"><nav class="svelte-h5mjvk"><h2 class="svelte-h5mjvk"><a href="../article" class="nav-heading-link">æ–‡ç« åˆ—è¡¨</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-10kcmdg"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-mdkbyj"><h1 class="svelte-mdkbyj">Auth &amp; Route 2</h1> <p class="svelte-mdkbyj">2025-12-09</p></div> <section class="article-body svelte-mdkbyj"><!----><h6>åŸºæ–¼ RBAC å¯¦ä½œæ¬Šé™æ§ç®¡å’Œç•«é¢æ¸²æŸ“ï¼Œé€™ç¯‡è™•ç†å‰ç«¯æ¶æ§‹ Service ã€ Route ã€ Guard</h6> <hr/> <h3>Service</h3> <p>Angular æœƒä½¿ç”¨ DI Service çš„æ–¹å¼ç¶­è­·ç‹€æ…‹ç®¡ç†èˆ‡å‡½æ•¸èª¿ç”¨ï¼Œé€šå¸¸æœƒæ˜¯ Singleton</p> <p>å…ˆç°¡å–®å¯¦ä½œ auth.service.ts è®“ APP å¯ä»¥åˆ¤å®šç™»å…¥ç‹€æ…‹</p> <pre class="language-ts"><!----><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Injectable<span class="token punctuation">,</span> signal <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Router <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> userPermissionData <span class="token keyword">from</span> <span class="token string">'../../../mockDB/userPermission.json'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ä½¿ç”¨ signal ç®¡ç†ç™»å…¥ç‹€æ…‹</span>
    <span class="token keyword">private</span> currentUser <span class="token operator">=</span> <span class="token generic-function"><span class="token function">signal</span><span class="token generic class-name"><span class="token operator">&lt;</span>User <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> token <span class="token operator">=</span> <span class="token generic-function"><span class="token function">signal</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å…¬é–‹çš„å”¯è®€ signal</span>
    <span class="token keyword">readonly</span> user$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span><span class="token function">asReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> isLoggedIn$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span><span class="token function">asReadonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> router<span class="token operator">:</span> Router<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// å¾ localStorage æ¢å¾©ç™»å…¥ç‹€æ…‹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">restoreSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
     */</span>
    <span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">currentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * ç™»å…¥
     * @returns &#123; success: boolean, message?: string &#125;
     */</span>
    <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> success<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> message<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// å¾ userPermission.json ä¸­æŸ¥æ‰¾ä½¿ç”¨è€…</span>
        <span class="token keyword">const</span> foundUser <span class="token operator">=</span> userPermissionData<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            u <span class="token operator">=></span> u<span class="token punctuation">.</span>username <span class="token operator">===</span> username <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span>password <span class="token operator">===</span> password
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
                success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                message<span class="token operator">:</span> <span class="token string">'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">const</span> user<span class="token operator">:</span> User <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            id<span class="token operator">:</span> foundUser<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            username<span class="token operator">:</span> foundUser<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            email<span class="token operator">:</span> foundUser<span class="token punctuation">.</span>email
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> token <span class="token operator">=</span> foundUser<span class="token punctuation">.</span>token<span class="token punctuation">;</span>

        <span class="token comment">// æ›´æ–°ç‹€æ…‹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å„²å­˜åˆ° localStorage</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            success<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * ç™»å‡º
     */</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ¸…é™¤ localStorage</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å°å‘ç™»å…¥é </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * å¾ localStorage æ¢å¾©ç™»å…¥ç‹€æ…‹
     */</span>
    <span class="token keyword">private</span> <span class="token function">restoreSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> userJson <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>userJson <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>userJson<span class="token punctuation">)</span> <span class="token keyword">as</span> User<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'æ¢å¾©ç™»å…¥ç‹€æ…‹å¤±æ•—'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * å–å¾—ç•¶å‰ä½¿ç”¨è€…
     */</span>
    <span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> User <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">currentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * å–å¾— Token
     */</span>
    <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>permission.service.ts ç”¨ä¾†è™•ç†æ¬Šé™ç›¸é—œï¼Œç›®å‰åŠŸèƒ½å®šç¾©æˆ</p> <ol><li>å­˜æ”¾ä½¿ç”¨è€…çš„æ¬Šé™ Singleton åœ¨å‰ç«¯</li> <li>å…¨éƒ¨çš„æ¬Šé™åˆ—è¡¨ï¼Œå› ç‚ºä¸æ˜¯æ©Ÿå¯†è³‡æ–™å¯ä»¥å›å‚³ï¼Œæ–¹ä¾¿æ•´ç†ç‹€æ…‹</li> <li>æ¥­å‹™é‚è¼¯è™•ç†</li></ol> <pre class="language-ts"><!----><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Injectable<span class="token punctuation">,</span> signal<span class="token punctuation">,</span> computed <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> AuthService <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> userPermissionData <span class="token keyword">from</span> <span class="token string">'../../../mockDB/userPermission.json'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * æ¬Šé™é¡å‹
 */</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> ClaimType <span class="token punctuation">&#123;</span>
    <span class="token constant">ROUTE</span> <span class="token operator">=</span> <span class="token string">'ROUTE'</span><span class="token punctuation">,</span>    <span class="token comment">// è·¯ç”±æ¬Šé™ï¼ˆé é¢è¨ªå•ï¼‰</span>
    <span class="token constant">ACTION</span> <span class="token operator">=</span> <span class="token string">'ACTION'</span>   <span class="token comment">// æ“ä½œæ¬Šé™ï¼ˆåŠŸèƒ½æŒ‰éˆ•ï¼‰</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * æ¬Šé™è²æ˜ä»‹é¢
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Claim</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    type<span class="token operator">:</span> ClaimType<span class="token punctuation">;</span>
    module<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    parentId<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * ä½¿ç”¨è€…æ¬Šé™é—œè¯ä»‹é¢
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UserClaim</span> <span class="token punctuation">&#123;</span>
    userId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    claimId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * æ¬Šé™æ¨¹ç¯€é»ï¼ˆç”¨æ–¼å»ºç«‹éšå±¤çµæ§‹ï¼‰
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ClaimTreeNode</span> <span class="token keyword">extends</span> <span class="token class-name">Claim</span> <span class="token punctuation">&#123;</span>
    children<span class="token operator">:</span> ClaimTreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PermissionService</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// æ‰€æœ‰æ¬Šé™å®šç¾©</span>
    <span class="token keyword">private</span> allClaims <span class="token operator">=</span> <span class="token generic-function"><span class="token function">signal</span><span class="token generic class-name"><span class="token operator">&lt;</span>Claim<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç•¶å‰ä½¿ç”¨è€…çš„æ¬Šé™ ID åˆ—è¡¨</span>
    <span class="token keyword">private</span> userClaimIds <span class="token operator">=</span> <span class="token generic-function"><span class="token function">signal</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç•¶å‰ä½¿ç”¨è€…çš„æ¬Šé™ç‰©ä»¶åˆ—è¡¨(List)ï¼ˆcomputedï¼‰</span>
    <span class="token keyword">readonly</span> userClaims <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> claimIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userClaimIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">allClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>claim <span class="token operator">=></span> claimIds<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>claim<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç•¶å‰ä½¿ç”¨è€…çš„æ¬Šé™æ¨¹ç‹€çµæ§‹ï¼ˆcomputed, åƒ…åŒ…å«ä½¿ç”¨è€…æ“æœ‰çš„æ¬Šé™ï¼‰</span>
    <span class="token keyword">readonly</span> userClaimTree <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span>ClaimTreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// å–å¾—ä½¿ç”¨è€…æ“æœ‰çš„æ¬Šé™åˆ—è¡¨</span>
        <span class="token keyword">const</span> userClaimList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç”¨ Map å„²å­˜ç¯€é»ï¼Œæ–¹ä¾¿é€é ID æŸ¥æ‰¾çˆ¶ç¯€é»</span>
        <span class="token keyword">const</span> claimMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">,</span> ClaimTreeNode<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. åˆå§‹åŒ–ä½¿ç”¨è€…æ“æœ‰çš„ç¯€é»</span>
        userClaimList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>claim <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// ä½¿ç”¨å±•é–‹é‹ç®—å­ (...) å»ºç«‹ä¸€å€‹æ–°çš„ç‰©ä»¶ï¼Œç¬¦åˆ ClaimTreeNode ä»‹é¢</span>
            claimMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>claim<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>claim<span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. å»ºç«‹æ¨¹ç‹€çµæ§‹ä¸¦éæ¿¾</span>
        <span class="token keyword">const</span> rootNodes<span class="token operator">:</span> ClaimTreeNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        claimMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>node <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>parentId <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// æ ¹ç¯€é» (ParentId ç‚º null) ç›´æ¥åŠ å…¥æ ¹åˆ—è¡¨</span>
                rootNodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// å˜—è©¦å¾ claimMap ä¸­å–å¾—çˆ¶ç¯€é»</span>
                <span class="token keyword">const</span> parent <span class="token operator">=</span> claimMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>parentId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ç¢ºä¿çˆ¶ç¯€é»å­˜åœ¨ (å› ç‚ºæˆ‘å€‘åªè™•ç†ä½¿ç”¨è€…æ“æœ‰çš„ç¯€é»ï¼Œæ‰€ä»¥ parentId å¿…é ˆåœ¨ claimMap å…§)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. å›å‚³æ¨¹çš„æ ¹ç¯€é»åˆ—è¡¨</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'userClaimTree'</span><span class="token punctuation">,</span> rootNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rootNodes<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¬Šé™æ˜¯å¦å·²è¼‰å…¥</span>
    <span class="token keyword">private</span> isLoaded <span class="token operator">=</span> <span class="token generic-function"><span class="token function">signal</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// è¼‰å…¥æ‰€æœ‰æ¬Šé™å®šç¾©</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç›£è½ç™»å…¥ç‹€æ…‹ï¼Œè‡ªå‹•è¼‰å…¥ä½¿ç”¨è€…æ¬Šé™</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">user$</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadUserClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * è¼‰å…¥æ‰€æœ‰æ¬Šé™å®šç¾©
     */</span>
    <span class="token keyword">private</span> <span class="token function">loadClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> claims <span class="token operator">=</span> userPermissionData<span class="token punctuation">.</span>claims<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>claim <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            id<span class="token operator">:</span> claim<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            code<span class="token operator">:</span> claim<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
            name<span class="token operator">:</span> claim<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            type<span class="token operator">:</span> claim<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> ClaimType<span class="token punctuation">,</span>
            module<span class="token operator">:</span> claim<span class="token punctuation">.</span>module<span class="token punctuation">,</span>
            parentId<span class="token operator">:</span> claim<span class="token punctuation">.</span>parentId
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>allClaims<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * è¼‰å…¥ç•¶å‰ä½¿ç”¨è€…çš„æ¬Šé™
     */</span>
    <span class="token function">loadUserClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userClaimIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isLoaded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// å¾ userPermission.json ä¸­æŸ¥æ‰¾è©²ä½¿ç”¨è€…çš„æ¬Šé™</span>
        <span class="token keyword">const</span> userClaimRelations <span class="token operator">=</span> userPermissionData<span class="token punctuation">.</span>userClaims<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
            uc <span class="token operator">=></span> uc<span class="token punctuation">.</span>userId <span class="token operator">===</span> user<span class="token punctuation">.</span>id
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> claimIds <span class="token operator">=</span> userClaimRelations<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>uc <span class="token operator">=></span> uc<span class="token punctuation">.</span>claimId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userClaimIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>claimIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isLoaded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * æ ¸å¿ƒæ–¹æ³•ï¼šæª¢æŸ¥æ˜¯å¦æœ‰æŒ‡å®šçš„æ¬Šé™
     * @param claimCode æ¬Šé™ä»£ç¢¼ï¼Œä¾‹å¦‚ 'BASIC_SYSTEM_LOG_VIEW'
     */</span>
    <span class="token function">hasClaim</span><span class="token punctuation">(</span>claimCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> claim <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">allClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> claimCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>claim<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">æ¬Šé™ä»£ç¢¼ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>claimCode<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> ä¸å­˜åœ¨</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userClaimIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>claim<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * æª¢æŸ¥æ¬Šé™æ˜¯å¦å·²è¼‰å…¥
     */</span>
    <span class="token function">isPermissionLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * æ¸…é™¤ä½¿ç”¨è€…æ¬Šé™ï¼ˆç™»å‡ºæ™‚ä½¿ç”¨ï¼‰
     */</span>
    <span class="token function">clearUserClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userClaimIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isLoaded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Debug ç”¨ï¼šå°å‡ºç•¶å‰ä½¿ç”¨è€…çš„æ‰€æœ‰æ¬Šé™
     */</span>
    <span class="token function">debugPrintUserClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">'ğŸ” ä½¿ç”¨è€…æ¬Šé™åˆ—è¡¨'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ä½¿ç”¨è€…:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æ¬Šé™æ•¸é‡:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">groupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>Service è™•ç†å®Œå¾Œï¼Œå°±æ‡‰è©²è¦æ‹¿åˆ°æ‰€æœ‰ Auth &amp; Route éœ€è¦ä½¿ç”¨åˆ°çš„è³‡æ–™äº†</p> <h3>Route</h3> <p>å†ä¾†è™•ç† route çš„éƒ¨åˆ†ï¼Œangular å¥—ä»¶æœ‰æä¾› canActivate å±¬æ€§ç•¶ä½œè·¯ç”±å®ˆè¡›</p> <p>app.routes.ts</p> <pre class="language-ts"><!----><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Routes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Login <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./pages/login/login'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> MainLayoutComponent <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./core/layout/main-layout.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> authGuard <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./core/guards/auth.guard'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Unauthorized <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./pages/unauthorized/unauthorized'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> <span class="token constant">ROUTE_CONFIGS</span><span class="token punctuation">,</span> convertToRoutes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./core/config/route.config'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span> <span class="token string">'login'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> Login
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span> <span class="token string">'unauthorized'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> Unauthorized
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> MainLayoutComponent<span class="token punctuation">,</span>
        canActivate<span class="token operator">:</span> <span class="token punctuation">[</span>authGuard<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// éœ€è¦ç™»å…¥æ‰èƒ½è¨ªå•</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                path<span class="token operator">:</span> <span class="token string">'basic-system/log'</span><span class="token punctuation">,</span>
                requiredClaim<span class="token operator">:</span> ClaimCode<span class="token punctuation">.</span><span class="token constant">BASIC_SYSTEM_LOG</span><span class="token punctuation">,</span>
                <span class="token function-variable function">loadComponent</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../../features/basic-system/system-log.component'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=></span> m<span class="token punctuation">.</span>SystemLogComponent<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
                path<span class="token operator">:</span> <span class="token string">'external-system/vendor-data'</span><span class="token punctuation">,</span>
                canActivate<span class="token operator">:</span> <span class="token punctuation">[</span>permissionGuard<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// éœ€è¦æœ‰æ¬Šé™æ‰èƒ½è¨ªå•</span>
                requiredClaim<span class="token operator">:</span> ClaimCode<span class="token punctuation">.</span><span class="token constant">EXTERNAL_SYSTEM_VENDOR_DATA</span><span class="token punctuation">,</span>
                <span class="token function-variable function">loadComponent</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../../features/external-system/vendor-data.component'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=></span> m<span class="token punctuation">.</span>VendorDataComponent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                reuseRoute<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span> <span class="token string">'**'</span><span class="token punctuation">,</span>
        redirectTo<span class="token operator">:</span> <span class="token string">'/login'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code><!----></pre> <h3>Guard</h3> <p>æ³¨å…¥ Service æª¢æŸ¥ç™»å…¥ &amp; æ¬Šé™ç‹€æ…‹ä¾†å¯¦ä½œäºŒå€‹å®ˆè¡›ï¼Œ authGuard å¤±æ•—è·³è½‰åˆ°ç™»å…¥é é¢ã€permissionGuard å¤±æ•—è·³è½‰åˆ°æœªæˆæ¬Šç•«é¢ã€‚</p> <pre class="language-ts"><!----><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> inject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Router<span class="token punctuation">,</span> CanActivateFn <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> AuthService <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../services/auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> PermissionService <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../services/permission.service'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * è·¯ç”±å®ˆè¡› - æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> authGuard<span class="token operator">:</span> <span class="token function-variable function">CanActivateFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>route<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> authService <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>AuthService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authService<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// å…è¨±è¨ªå•</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é </span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> router<span class="token punctuation">.</span><span class="token function">createUrlTree</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/login'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        queryParams<span class="token operator">:</span> <span class="token punctuation">&#123;</span> returnUrl<span class="token operator">:</span> state<span class="token punctuation">.</span>url <span class="token punctuation">&#125;</span>  <span class="token comment">// è¨˜ä½åŸæœ¬è¦å»çš„é é¢</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * æ¬Šé™å®ˆè¡› - æª¢æŸ¥ä½¿ç”¨è€…
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> permissionGuard<span class="token operator">:</span> <span class="token function-variable function">CanActivateFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>route<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> permissionService <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>PermissionService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¾ route data å–å¾—æ‰€éœ€çš„æ¬Šé™ä»£ç¢¼</span>
    <span class="token comment">// children: [</span>
    <span class="token comment">// &#123;</span>
    <span class="token comment">//     path: 'basic-system/log',</span>
    <span class="token comment">//     requiredClaim: ClaimCode.BASIC_SYSTEM_LOG,</span>
    <span class="token comment">// &#125;,</span>
    <span class="token keyword">const</span> requiredClaim <span class="token operator">=</span> route<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">'requiredClaim'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

    <span class="token comment">// æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ‰€éœ€æ¬Šé™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionService<span class="token punctuation">.</span><span class="token function">hasClaim</span><span class="token punctuation">(</span>requiredClaim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// æ²’æœ‰æ¬Šé™ï¼Œå°å‘æœªæˆæ¬Šé é¢</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ï¼Œéœ€è¦æ¬Šé™: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>requiredClaim<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> router<span class="token punctuation">.</span><span class="token function">createUrlTree</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/unauthorized'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

</code><!----></pre> <p>é€™é‚Šåšå¥½å¯ä»¥å…ˆç´”è¼¸å…¥ URL æ¸¬è©¦ route åŠŸèƒ½ï¼Œå‰©ä¸‹å°±æ˜¯çœ‹è¦æ€éº¼æ•´ç†æ•¸æ“šï¼Œé›†ä¸­ç®¡ç†è½‰çµ¦ Component render</p><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_slbq0u = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.DDqIF5JP.js"),
						import("../_app/immutable/entry/app.CjO81wrs.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
