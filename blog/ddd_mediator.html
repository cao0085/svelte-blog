<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.CZsgKNMF.css" rel="stylesheet">
		<link href="../_app/immutable/assets/2.CTG3EflP.css" rel="stylesheet">
		<link href="../_app/immutable/assets/4.DwwtVzUN.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.BMATaX8Q.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CUmunC8v.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CX9Gwrfj.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DK5zR4CQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/4SwWjBeO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cj296wHD.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.CzZ0JYMN.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CoAyLVH3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/0BP-6TFY.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B-RvVA6v.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bzx_H5h9.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BWZxhN5V.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CZzLNGhg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DlG8Uxfu.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/2.McoYecku.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_bzESNuN.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Di4srW5m.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/4.B5drr8OA.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="app svelte-1t5f27d"><header class="svelte-1wpzjs"><div class="title svelte-1wpzjs">Blog</div></header><!----> <main class="svelte-1t5f27d"><!--[--><!----><div class="blog-layout svelte-1clyl0w"><aside class="svelte-1clyl0w"><nav><h2><a href="../blog" class="nav-heading-link">文章列表</a></h2> <!--[--><section><button class="category-toggle">Software</button> <!--[!--><!--]--></section><!--]--></nav><!----></aside> <main class="svelte-1clyl0w"><!----><!----><!--[--><article class="prose mx-auto"><div class="article-header svelte-1l2p5et"><h1 class="svelte-1l2p5et">Mediator</h1> <p class="svelte-1l2p5et">2025-06-22</p></div> <section class="article-body svelte-1l2p5et"><!----><h6>事件驅動搭配中介者模式</h6> <hr/> <h2>MediatR</h2> <p>用於應用程式內部模組之間的指令與事件傳遞，運作於主記憶體中不需外部中介。自身架構處理 Command、Query、Domain Event，也可擴充 IPipelineBehavior 實作驗證、日誌、監控等。若搭配 Outbox 實作，亦可延伸為可靠事件傳遞模式。</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">//.csproj</span>
<span class="token operator">&lt;</span><span class="token class-name">PackageReference</span> Include<span class="token operator">=</span><span class="token string">"MediatR"</span> Version<span class="token operator">=</span><span class="token string">"12.5.0"</span> <span class="token operator">/</span><span class="token operator">></span>

<span class="token comment">//Program.cs</span>
builder<span class="token punctuation">.</span><span class="token function">InstallMediatR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p>放入自定義的<strong>Command</strong>後，會自動註冊所有 <code>IRequestHandler&lt;,></code>、<code>INotificationHandler&lt;></code> 相關的 Handler</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">// Infrastructure/Installers/MediatRInstaller.cs</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InstallMediatR</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">WebApplicationBuilder</span> builder<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddMediatR</span><span class="token punctuation">(</span>cfg <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterServicesFromAssemblyContaining</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>LoginUserCommand<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterServicesFromAssemblyContaining</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RefreshTokenCommand<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p><strong>Send 流程（Command / Query）</strong></p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoginUserCommand</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"pwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p>背後處理步驟：</p> <ol><li>呼叫 Send() → 取得 command 型別（如 LoginUserCommand）</li> <li>檢查快取中有沒有 RequestHandlerWrapper<code>&lt;LoginUserCommand, TResult></code></li> <li>若無，透過反射產生 Wrapper 並快取</li> <li>Wrapper 使用 DI container (ServiceFactory) 找出對應的 LoginUserCommandHandler</li> <li>包上所有 IPipelineBehavior（如 Logging / Validation）</li> <li>呼叫 Handle() 執行實際邏輯</li></ol> <p><strong>Publish 流程（Event）</strong></p> <p>會呼叫所有註冊的 INotificationHandler<code>&lt;UserLoggedInNotification></code> 處理器
適合用於事件廣播 / DomainEvent 傳遞（例如搭配 Outbox）</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserLoggedInNotification</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p><strong>Controller 呼叫</strong></p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">LoginUserCommand</span> command<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p><strong>IPipelineBehavior</strong></p> <p>MediatR 在處理 Send() 時，會把整個流程包裝在一連串的 IPipelineBehavior<code>&lt;TRequest, TResponse></code> 中，最後才執行真正的 Handle() 方法。</p> <p><code>Client → [LoggingBehavior] → [ValidationBehavior] → CommandHandler.Handle()</code></p> <p>每一個 Behavior 都像 Middleware，可以：</p> <ul><li>做前置驗證（FluentValidation）</li> <li>加入日誌記錄（ILogger）</li> <li>加入監控（OpenTelemetry, AppInsights）</li> <li>加入自定義錯誤處理、授權檢查</li></ul> <pre class="language-csharp"><!----><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddTransient</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IPipelineBehavior<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">LoggingBehavior<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddTransient</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IPipelineBehavior<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ValidationBehavior<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <br/> <h2>MassTransit</h2> <p>適合分散式系統中的服務間訊息通訊，需外部 message broker（如 RabbitMQ、Kafka）。支援 Command / Event 發送，可串接 Retry、延遲隊列、DeadLetter 等進階功能，常用於微服務間傳遞資料、非同步背景處理等情境。</p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">// .csproj</span>
<span class="token operator">&lt;</span><span class="token class-name">PackageReference</span> Include<span class="token operator">=</span><span class="token string">"MassTransit.AspNetCore"</span> Version<span class="token operator">=</span><span class="token string">"8.1.2"</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token class-name">PackageReference</span> Include<span class="token operator">=</span><span class="token string">"MassTransit.RabbitMQ"</span> Version<span class="token operator">=</span><span class="token string">"8.1.2"</span> <span class="token operator">/</span><span class="token operator">></span></code><!----></pre> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token comment">// Program.cs</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddMassTransit</span><span class="token punctuation">(</span>x <span class="token operator">=></span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 自動註冊所有的消費者 (Consumer)</span>
    <span class="token comment">// 表示該層級專案</span>
    x<span class="token punctuation">.</span><span class="token function">AddConsumers</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CreateUserConsumer</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">UsingRabbitMq</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">"rabbitmq://localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">ConfigureEndpoints</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自動綁定 queue</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p><strong>Send()</strong></p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">await</span> _sendEndpoint<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenerateInvoice</span> <span class="token punctuation">&#123;</span> OrderId <span class="token operator">=</span> <span class="token string">"123"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p><strong>Publish()</strong></p> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token keyword">await</span> _publishEndpoint<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserCreated</span> <span class="token punctuation">&#123;</span> UserId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p><strong>Middleware pipeline</strong></p> <pre class="language-csharp"><!----><code class="language-csharp">cfg<span class="token punctuation">.</span><span class="token function">ConfigureMediator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 驗證資料結構</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ValidationFilter<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>type <span class="token operator">=></span> <span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasInterface</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDomainEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">LoggingFilter<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>type <span class="token operator">=></span> <span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasInterface</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDomainEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">RedisFilter<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>type <span class="token operator">=></span> <span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasInterface</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDomainEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EventsFilter<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>type <span class="token operator">=></span> <span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasInterface</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDomainEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cfg<span class="token punctuation">.</span><span class="token function">UseConsumeFilter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">HtmlSanitizerFilter<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">Include</span><span class="token punctuation">(</span>type <span class="token operator">=></span> <span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">HasInterface</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDomainEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <pre class="language-csharp"><!----><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"register"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">IPublishEndpoint</span> publishEndpoint<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> publishEndpoint<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CreateUser</span> <span class="token punctuation">&#123;</span> UserName <span class="token operator">=</span> <span class="token string">"tony"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">"Published!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!----></section></article><!--]--><!----><!----></main></div><!----><!--]--><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1beiis6 = {
						base: new URL("..", location).pathname.slice(0, -1),
						assets: "/svelte-blog"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.BMATaX8Q.js"),
						import("../_app/immutable/entry/app.CzZ0JYMN.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 4],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
